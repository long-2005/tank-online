version: '3.8'

services:
  # Auth Service - Dịch vụ xác thực và phục vụ web tĩnh
  auth-service:
    build:
      context: ./services/auth
      dockerfile: Dockerfile
    container_name: tank-auth
    ports:
      - "5000:5000" # Mở port cho Monitor Dashboard có thể truy cập
    environment:
      - PORT=5000
      - MONGO_URI=${MONGO_URI}
    volumes:
      - ./services/auth:/app
      - /app/node_modules
    restart: unless-stopped
    networks:
      - tank-network

  # Game Service Node 1
  game-service-1:
    build:
      context: ./services/game
      dockerfile: Dockerfile
    container_name: tank-game-1
    ports:
      - "6001:6000" # Mở port cho Monitor Dashboard
    environment:
      - PORT=6000
      - MONGO_URI=${MONGO_URI}
    volumes:
      - ./services/game:/app
      - /app/node_modules
    restart: unless-stopped
    networks:
      - tank-network

  # Game Service Node 2
  game-service-2:
    build:
      context: ./services/game
      dockerfile: Dockerfile
    container_name: tank-game-2
    ports:
      - "6002:6000" # Mở port cho Monitor Dashboard
    environment:
      - PORT=6000
      - MONGO_URI=${MONGO_URI}
    volumes:
      - ./services/game:/app
      - /app/node_modules
    restart: unless-stopped
    networks:
      - tank-network

  # Game Service Node 3
  game-service-3:
    build:
      context: ./services/game
      dockerfile: Dockerfile
    container_name: tank-game-3
    ports:
      - "6003:6000" # Mở port cho Monitor Dashboard
    environment:
      - PORT=6000
      - MONGO_URI=${MONGO_URI}
    volumes:
      - ./services/game:/app
      - /app/node_modules
    restart: unless-stopped
    networks:
      - tank-network

  # Nginx Load Balancer
  nginx:
    image: nginx:alpine
    container_name: tank-nginx
    ports:
      - "80:80"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./services/monitor:/usr/share/nginx/html/monitor:ro
    depends_on:
      - auth-service
      - game-service-1
      - game-service-2
      - game-service-3
    restart: unless-stopped
    networks:
      - tank-network

networks:
  tank-network:
    driver: bridge
