<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TANK ONLINE - SYSTEM MONITOR</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --text-color: #c9d1d9;
            --accent-green: #238636;
            --accent-red: #da3633;
            --accent-blue: #58a6ff;
            --border-color: #30363d;
            --font-mono: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-mono);
            margin: 0;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        h1 { margin: 0; font-size: 1.5rem; color: var(--accent-blue); text-transform: uppercase; letter-spacing: 2px; }
        .status-badge { padding: 5px 10px; border-radius: 4px; font-weight: bold; background: #333; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .service-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }

        .service-name { font-weight: bold; font-size: 1.1rem; color: var(--accent-blue); }
        .service-status { font-size: 0.9rem; }
        .status-up { color: #3fb950; }
        .status-down { color: #f85149; }

        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.85rem;
            margin-bottom: 15px;
            color: #8b949e;
        }

        .log-panel {
            background-color: #000;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            height: 250px;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.8rem;
            white-space: pre-wrap;
            color: #fff;
            box-shadow: inset 0 0 10px #000;
        }

        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-time { color: #8b949e; margin-right: 10px; }
        .log-msg { color: #e6edf3; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #58a6ff; }
    </style>
</head>
<body>

<header>
    <h1>System Monitor <span style="font-size:0.8em; color:#555;">v1.0</span></h1>
    <div id="global-timer" class="status-badge">...</div>
</header>

<div class="dashboard-grid" id="app">
    <!-- Cards will be injected here -->
</div>

<script>
    const SERVICES = [
        { id: 'auth', name: 'AUTH SERVICE', url: 'http://localhost:5000' },
        { id: 'game1', name: 'GAME NODE 1', url: 'http://localhost:6001' },
        { id: 'game2', name: 'GAME NODE 2', url: 'http://localhost:6002' },
        { id: 'game3', name: 'GAME NODE 3', url: 'http://localhost:6003' }
    ];

    const app = document.getElementById('app');

    // Init UI
    function init() {
        SERVICES.forEach(service => {
            const card = document.createElement('div');
            card.className = 'service-card';
            card.innerHTML = `
                <div class="card-header">
                    <span class="service-name">${service.name}</span>
                    <span class="service-status status-down" id="status-${service.id}">CONNECTING...</span>
                </div>
                <div class="metrics">
                    <div>UPTIME: <span id="uptime-${service.id}">-</span></div>
                    <div>DB: <span id="db-${service.id}">-</span></div>
                </div>
                <div class="log-panel" id="logs-${service.id}">
                    <div style="color: #555; text-align: center; padding-top: 100px;">Waiting for logs...</div>
                </div>
            `;
            app.appendChild(card);
        });
        updateTimer();
        setInterval(updateTimer, 1000);
        setInterval(refreshData, 2000); // Poll every 2s
        refreshData();
    }

    function updateTimer() {
        document.getElementById('global-timer').innerText = new Date().toLocaleTimeString();
    }

    async function refreshData() {
        SERVICES.forEach(async (service) => {
            // 1. Check Health
            try {
                const res = await fetch(`${service.url}/health`);
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById(`status-${service.id}`).innerText = "ONLINE";
                    document.getElementById(`status-${service.id}`).className = "service-status status-up";
                    document.getElementById(`uptime-${service.id}`).innerText = formatUptime(data.uptime);
                    document.getElementById(`db-${service.id}`).innerText = data.dbConnection || 'N/A';
                } else {
                    markDown(service.id);
                }
            } catch (e) {
                markDown(service.id);
            }

            // 2. Fetch Logs
            try {
                const res = await fetch(`${service.url}/api/logs`);
                if (res.ok) {
                    const logs = await res.json();
                    renderLogs(service.id, logs);
                }
            } catch (e) {
                // Ignore log fetch errors explicitly if health is down
            }
        });
    }

    function markDown(id) {
        document.getElementById(`status-${id}`).innerText = "OFFLINE";
        document.getElementById(`status-${id}`).className = "service-status status-down";
        document.getElementById(`uptime-${id}`).innerText = "-";
        document.getElementById(`db-${id}`).innerText = "-";
    }

    function formatUptime(seconds) {
        if (!seconds) return "0s";
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        return `${h}h ${m}m ${s}s`;
    }

    function renderLogs(id, logs) {
        const container = document.getElementById(`logs-${id}`);
        if (!logs || logs.length === 0) return;
        
        const html = logs.map(line => {
             const parts = line.split('] ');
             let time = parts[0] + ']';
             let msg = parts.slice(1).join('] ');
             if (!msg) { time = ''; msg = line; }
             return `<div class="log-entry"><span class="log-time">${time}</span><span class="log-msg">${msg}</span></div>`;
        }).join('');
        
        if (container.innerHTML !== html) {
             container.innerHTML = html;
             container.scrollTop = container.scrollHeight;
        }
    }

    init();
</script>

</body>
</html>
